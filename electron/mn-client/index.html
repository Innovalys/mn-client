<!DOCTYPE html>
<html>
  <head>
    <title>Manga Network</title>
	<meta charset="utf-8"/>
	<link rel="icon" type="image/png" href="images/icon.png" />
	<link rel="stylesheet" href="css/bootstrap.css" type="text/css"/>
	<link rel="stylesheet" href="css/font-awesome.min.css" type="text/css"/>
	<link rel="stylesheet" href="css/style.css" type="text/css"/>
  </head>
  <body>
	<div id="toast_back"></div>

    <script type="text/javascript">
		// Load external files
	    window.$ = window.jQuery = require('./jquery-2.1.4.min.js');
	    require('./MNFramework.js');
		var remote = require('remote');
		var __path = remote.getCurrentWindow().getPath();
		var endpoint = 'http://localhost/mn-server/';

		// TODO : Ajouter chapter_cur dans la BDD avec le n° de chapitre en cours
		//        Faire la page de lecture de manga

		// DEBUG
		$( document ).ready(function() {	
			$("body").on("keydown", function(e) {
				// F12 : show dev tools
				if(e.which == 123) {
					remote.getCurrentWindow().toggleDevTools();
				}
				// F1 : show test pop-up
				else if(e.which == 112) {
					MN.notify('Test', 'Message de test');
				}
			});
		});
		// DEBUG

	    // -- Nav bar
		// ---------------------------
		// Used to navigate through every pages of the application. The navbar is always present once connected
		var NavBar = MN.BaseElement.extend({
			init : function(renderer, values) {
				this._super();
				this.renderer = renderer;
				this.text = values.text;
			},
			_initSearchBar : function() {
				var me = this;
				var search_bar = $('<form class="navbar-form navbar-right" role="search"></form>');
				var input = $('<input type="text" class="form-control ipt-search" placeholder="Mangas, Auteurs, Chapitres">');
				var button = $('<button type="submit" class="btn btn-default" style="margin-left: 5px; margin-right: -10px"><i class="fa fa-search"></i></button>');
				
				// Bind search events
				input.keypress(function(e) {
					if ( e.which == 13 ) {
						e.preventDefault();
						me.fireEvent('search', e, input.val());
					}
				});
				button.on('click', function(e) {
					e.preventDefault();
					me.fireEvent('search', e, input.val());
				});
				
				search_bar.append($('<div class="form-group"></div>').append(input)).append(button);
				this.container.append(search_bar);
			},
			_initButtons : function() {
				var me = this;
				var buttons = $('<ul class="nav navbar-nav">');
				
				// Homepage
				var home_button = $('<li><a href="#">Mon Espace</a></li>');
				home_button.on('click', function(e) { me.fireEvent('homepage', e); });
				buttons.append(home_button);
				
				// Mangas
				var manga_button = $('<li><a href="#">Mes Mangas</a></li>');
				manga_button.on('click', function(e) { me.fireEvent('mangapage', e); });
				buttons.append(manga_button);
				
				// Search
				var search_button = $('<li><a href="#">Recherche avancée</a></li>');
				search_button.on('click', function(e) { me.fireEvent('searchpage', e); });
				buttons.append(search_button);
				
				this.container.append(buttons);
			},
			_initLogo : function() {
				var logo = $('<a class="navbar-brand logo" href="#"></a>');
				logo.append('<i class="fa fa-book fa-2x"></i>');
				
				this.container.append(logo);
			},
			_initUsername : function() {
				var navbar = $('<ul class="nav navbar-nav navbar-right"></ul>')
				var username = $('<a href="#" aria-expanded="false">Username</a>');
				
				navbar.append('<li><a>&nbsp;</a></li>').append($('<li></li>').append(username));
				
				this.container.append(navbar);
			},
			show : function() {
				this.container = $('<nav class="navbar navbar-default container-fluid"></nav>');
				this.container.css({ display : 'none' });

				this._initLogo();
				this._initButtons();
				this._initUsername();
				this._initSearchBar();

				this.renderer.append(this.container);
				this.container.slideDown();
			}
		});
		
		// -- Manga view TODO
		// ---------------------------
		// View displaying informations about the selected manga
		var MangaInfo = MN.BaseElement.extend({
			init : function(renderer, values) {
				this._super();
				this.renderer = renderer;
				this.user = values.user;
				this.manga = values.manga;
				console.log(values.manga);
			},
			_initTitle : function() {
				var title = $('<h1>' + this.manga.title + '</h1>');
				
				this.infoContainer.append(title);
			},
			_initInfos : function() {
				var me = this;
				
				var panel = $('<div class="panel panel-default"></div>');
				var header = $('<div class="panel-heading"><h3 class="panel-title">Information du manga</h3></div>');
				var content = $('<div class="panel-body"></div>');
				
				var info = $('<ul></ul>');
				info.append($('<li></li>').html('Source : ' + this.manga.source_URL));
				info.append($('<li></li>').html('Dernière mise à jour : ' + this.manga.update_date));
				info.append($('<li></li>').html('Date de sortie : ' + this.manga.release_date));
				info.append($('<li></li>').html('Nombre de chapitres : ' + this.manga.chapter_nb));
				
				var genres = $('<li></li>').html('Genre(s) : ');
				if(this.manga.genres) {
					this.manga.genres.forEach(function(genre) {
						var button = $('<button type="button" class="btn btn-info btn-xs btn-tag">' + genre + '</button>');
						button.on('click', function(e) {
							me.fireEvent('search', e, { genre : genre });
						});
						genres.append(button);
					});
					
					info.append(genres);
				} else {
					genres.append($('<button type="button" class="btn btn-info btn-xs disabled">[Aucun]</button>'));
				}
				
				var authors = $('<li></li>').html('Auteur(s) : ');
				if(this.manga.authors) {
					this.manga.authors.forEach(function(author) {
						var button = $('<button type="button" class="btn btn-info btn-xs btn-tag">' + author + '</button>');
						button.on('click', function(e) {
							me.fireEvent('search', e, { author : author });
						});
						authors.append(button);
					});
					
					info.append(authors);
				} else {
					authors.append($('<button type="button" class="btn btn-info btn-xs disabled">[Aucun]</button>'));
				}
				
				content.append(info);
				
				this.infoContainer.append(panel.append(header).append(content));
			},
			_initUserInfo : function() {
				var me = this;
				
				var panel = $('<div class="panel panel-default"></div>');
				var header = $('<div class="panel-heading"><h3 class="panel-title">Information dans la collection</h3></div>');
				var content = $('<div class="panel-body"></div>');
				
				var info = $('<ul></ul>');
				info.append($('<li></li>').html('Favoris : ' + ( this.manga.user_info.favoris ? 'Oui' : 'Non' )));
				info.append($('<li></li>').html('Dernière mise à jour : ' + this.manga.user_info.update_date));
				info.append($('<li></li>').html('Note attribuée : ' + (this.manga.user_info.note != null ? this.manga.user_info.note + "/5": "Aucune" )));
				
				var removeButton = $('<button type="button" class="btn btn-danger btn-xs left-space" style="margin-left: 23px;">Retirer de la collection</button>');
				var favorisButton = $('<button type="button" class="btn btn-warning btn-xs">' + (this.manga.user_info.favoris ? 'Retirer des favoris' : 'Ajouter aux favoris') + '</button>');
				
				removeButton.on('click', function(e) {
					me.fireEvent('collection', e, me.manga, 'remove');
				});
				
				favorisButton.on('click', function(e) {
					me.fireEvent('favoris', e, me.manga, (me.manga.user_info.favoris ? 'remove' : 'add'));
				});
				
				content.append(info);
				content.append(removeButton).append(favorisButton);
				
				this.infoContainer.append(panel.append(header).append(content));
			},
			_initNoUserInfo : function() {
				var me = this;
				
				var panel = $('<div class="panel panel-default"></div>');
				var header = $('<div class="panel-heading"><h3 class="panel-title">Information dans la collection</h3></div>');
				var content = $('<div class="panel-body"></div>');
				
				var info = $('<p>Ce manga n\'est pas encore dans votre collection. Si vous souhaitez le lire, vous devez l\'ajouter à votre collection</p>');
				var addButton = $('<button type="button" class="btn btn-primary btn" style="float: right;">Ajouter à la collection</button>');

				addButton.on('click', function(e) {
					me.fireEvent('collection', e, me.manga, 'add');
				});
				
				content.append(info);
				content.append(addButton);
				
				this.infoContainer.append(panel.append(header).append(content));
			},
			_initResume : function() {
				var panel = $('<div class="panel panel-default"></div>');
				var header = $('<div class="panel-heading"><h3 class="panel-title">Description du manga</h3></div>');
				var content = $('<div class="panel-body"></div>');
				
				content.append($("<p></p>").html(this.manga.description));
				
				this.infoContainer.append(panel.append(header).append(content));
			},
			_initRightPanel : function() {
				this.infoContainer = $('<div class="container col-md-8" ></div>');
				
				this._initTitle();
				if(this.manga.user_info != null)
					this._initUserInfo();
				else
					this._initNoUserInfo();
					
				this._initInfos();
				this._initResume();
				
				this.container.append(this.infoContainer)
			},
			_initLeftPanel : function() {
				var me = this;
				
				var container = $('<div class="container col-md-4" ></div>');
				var panel = $('<img class="img-responsive" class="container" style="width: 100%; margin-top: 22px" src="' + __path + '/images/cover.jpg" title="' + this.manga.title + '" alt="' + this.manga.title + '" />');
				var button = $('<button type="button" class="btn btn-primary btn-lg btn-block" style="margin-top: 22px;">' + (this.manga.user_info.page_cur ? 'Reprendre la lecture' : 'Commencer la lecture') + '</button>');
									
				// Load the real image
				remote.getCurrentWindow().getFile(user.dir, this.manga.cover, function (path, error) {
					if(path != null)
						panel.attr('src', path);
				});
					
				if(this.manga.user_info != null) {
					button.on('click', function(e) {
						me.fireEvent('manga-read', e, me.manga);
					});
				} else {
					button.addClass("disabled");
					button.on('click', function(e) {
						MN.notify('Lecture manga', 'Vous devez ajouter ce mange à votre collection personnelle avant de pouvoir le lire.');
					});
				}
				
				var progress = $('<div class="progress manga-progress"></div>');
				if(this.manga.user_info != null) {
					var value = 0;
					
					console.log(this.manga.user_info);
					
					if(this.manga.user_info.chapter_cur) {
						value = ((0 + this.manga.user_info.chapter_cur) / (0 + this.manga.chapter_nb) * 100).toFixed(1);
					}
					
					progress.append($('<div class="progress-bar" role="progressbar" style="min-width: 2em; width: ' + value + '%;">' + value + '%</div>'));
				}
				
				this.container.append(container.append(panel).append(button).append(progress));
			},
			show : function() {
				this.container = $('<div class="container" ></div>');

				this._initLeftPanel();
				this._initRightPanel();
				
				this.renderer.append(this.container);
			}
		});
		
		// -- Manga chapter read view TODO
		// ---------------------------
		// View allowing the user to read a page for a chapter of a manga
		var MangaChapter = MN.BaseElement.extend({
			init : function(renderer, values) {
				this._super();
				this.renderer = renderer;
				this.manga = values.manga;
				this.chapter_nb = this.manga.user_info.chapter_cur ?  this.manga.user_info.chapter_cur : 1;
				this.page_nb = this.manga.user_info.page_cur;
			},
			_initLeftPanel : function() {
				
			},
			_initRightPanel : function() {
				var me = this;
				this.mangaPages = $('<div class="container col-md-8" ></div>');
				console.log(endpoint + 'user/manga/id/' + this.manga.id + '/' + this.chapter_nb);
				// Perform the request
				$.ajax({
					type: 'GET',
					url: endpoint + 'user/manga/id/' + this.manga.id + '/' + this.chapter_nb,
					dataType : 'json',
					headers : MN.authHeader(user.login, user.password),
					success: function(data) {
						me._initMangaPages(data.data);
					},
					error: function(reponse) {
						MN.handleRequestError(reponse);
					},
					fail: function(reponse) {
						MN.handleRequestFail(reponse);
					}
				});
				
				this.container.append(this.mangaPages);
			},
			_initMangaPages : function(chapter) {
				this.chapter = chapter;
				
				var me = this;
				var title = $('<h3>' + chapter.title + '</h3>');
				
				this.mangaPages.append(title);
				
				chapter.pages.forEach(function(page) {
					
					var image = $('<img class="img-responsive container" src="' + __path + '/images/cover.jpg" alt="' + chapter.title + '(' + page.page_nb + ')" />');
					me.mangaPages.append(image);
					
					// Load the real image
					remote.getCurrentWindow().getFile(user.dir, page.link, function (path, error) {
						if(path != null)
							panel.attr('src', path);
					});
				});
			},
			show : function() {
				this.container = $('<div class="container" ></div>');

				this._initLeftPanel();  // Info & buttons
				this._initRightPanel(); // Pages
				
				this.renderer.append(this.container);
				
				
				this.container = $('<div class="container"></div>');
				var title = $('<h2>' + this.manga.title + '</h2>');

				// TODO
				
				this.renderer.append(this.container.append(title));
			}
		});
		
		// -- Home page
		// ---------------------------
		// View displaying general informations
		var HomePage = MN.BaseElement.extend({
			init : function(renderer, values) {
				this._super();
				this.renderer = renderer;
			},
			_initLastFavoris : function() {
				var panel = $('<div class="panel panel-default"></div>');
				var header = $('<div class="panel-heading"><h3 class="panel-title">Derniers manga favoris</h3></div>');
				this.favorisRenderer = $('<div class="panel-body"></div>');
				
				this.firstLine.append(panel.append(header).append(this.favorisRenderer));
			},
			_initLastNonFavoris : function() {
				var panel = $('<div class="panel panel-default"></div>');
				var header = $('<div class="panel-heading"><h3 class="panel-title">Derniers mangas</h3></div>');
				this.nonFavorisRenderer = $('<div class="panel-body"></div>');
				
				this.firstLine.append(panel.append(header).append(this.nonFavorisRenderer));
			},
			_updateMangaList : function(values, renderer) {
				var me = this;
				renderer.empty();
				
				values.forEach(function(manga) {
					
					var panel = $('<img class="img-responsive" src="' + __path + '/images/cover.jpg" title="' + manga.title + '" alt="' + manga.title + '" />');
					renderer.append(panel);
					
					panel.on('click', function(e) {
						me.fireEvent("manga", e, manga);
					});
					
					// Load the real image
					remote.getCurrentWindow().getFile(user.dir, manga.cover, function (path, error) {
						if(path != null) {
							console.log(manga.cover);
							console.log(path);
							panel.attr('src', path);
						} else {
							// TODO : handle error
						}
					});
				});
			},
			_updateValues : function() {
				var me = this;
				
				// Perform the request
				$.ajax({
					type: 'GET',
					url: 'http://localhost/mn-server/user/mangas/' + user.id,
					dataType : 'json',
					headers : MN.authHeader(user.login, user.password),
					success: function(data) {
						var values = data.data;
						var mangaFavoris = [];
						var mangaNonFavoris = [];
						
						for(var i = 0; i < values.length; i++) {
							if(values[i].user_info.favoris == 1)
								mangaFavoris.push(values[i]);
							else
								mangaNonFavoris.push(values[i]);
						}
						
						// Update the view
						me._updateMangaList(mangaFavoris, me.favorisRenderer);
						me._updateMangaList(mangaNonFavoris, me.nonFavorisRenderer);
					},
					error: function(data) {
						MN.handleRequestError(reponse);
					},
					fail: function(data) {
						MN.handleRequestFail(reponse);
					}
				});
			},
			show : function() {
				this.container = $('<div class="container"></div>');
				this.firstLine = $('<div class="row"></div>');
				this.secondLine = $('<div class="row"></div>');

				this._initLastFavoris();
				this._initLastNonFavoris();
				
				this.renderer.append(this.container.append(this.firstLine).append(this.secondLine));
				
				this._updateValues();

			}
		});
		
		// TODO : login
		var user = { id : 1, login : "test", password : "test", dir : "1_test" };
		
		// Prepare page
		var page = $('<div class="main-container"></div>');
		
		var navBar = new NavBar($('body'), {});
		navBar.on('search', function(e, value) {
			page.fadeOut(200, function() {
				page.empty();
				
				remote.getCurrentWindow().getFile("tmp", "http://i.imgur.com/13UAjUl.jpg", function (path) {
					var img = $('<img />');
					img.attr('width', '300px');
						
					if(path != null) {
						img.attr('src', path);
						
						page.append(img);
						page.fadeIn(200);
						
						console.log(path);
					}
					
					
				});
			});
		}).on('homepage', function(e) {
			page.fadeOut(200, function() {
				page.empty();
				
				var hp = new HomePage(page);
				hp.on('manga', function(e, manga) {
					var manga = manga;
					
					// Show manga informations
					page.fadeOut(200, function() {
						page.empty();
						var mangainfo = new MangaInfo(page, { manga : manga });
						mangainfo.on('manga-read', function (e) {
							
							// Show manga chapter
							page.fadeOut(200, function() {
								page.empty();
								var mangareader = new MangaChapter(page, { manga : manga });
								mangareader.show();
								page.fadeIn(200);
							});
							
						});
						
						mangainfo.show();
						page.fadeIn(200);
					});
				});
				
				hp.show();
				
				page.fadeIn(200);
			});
		}).show();
		
		$('body').append(page);
		
		// Show homepage
		navBar.fireEvent('homepage');
		
    </script>

  </body>
</html>